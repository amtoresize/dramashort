<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Short Drama - DramaShort</title>
  
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
    <style>
        /* Styles sama seperti sebelumnya, aku skip biar ringkas. Copy dari versi lama kalau perlu */
        body { background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 100%); color: white; min-height: 100vh; font-family: 'Segoe UI', system-ui, sans-serif; }
        .navbar-brand { font-weight: bold; font-size: 1.5rem; background: linear-gradient(90deg, #fff, #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .back-btn { border-radius: 50px; padding: 0.5rem 1.5rem; font-weight: 600; transition: all 0.3s; border: 2px solid #ff6b6b; color: #ff6b6b; background: transparent; }
        .back-btn:hover { transform: translateX(-5px); background: rgba(255, 107, 107, 0.1); color: #ff6b6b; border-color: #ff6b6b; }
        .drama-poster { border-radius: 16px; box-shadow: 0 12px 32px rgba(0,0,0,0.7); width: 100%; height: auto; max-height: 500px; object-fit: cover; border: 3px solid #ff6b6b; }
        .drama-title { font-size: 2.5rem; font-weight: 800; background: linear-gradient(90deg, #fff, #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .synopsis-box { background: rgba(30,30,30,0.7); border: 1px solid #444; border-radius: 12px; padding: 1.5rem; line-height: 1.8; border-left: 4px solid #ff6b6b; }
        .episode-card { margin-bottom: 1rem; }
        .episode-btn { border-radius: 12px; transition: all 0.3s ease; border: 2px solid #333; background: linear-gradient(145deg, #1e1e1e, #2a2a2a); color: white; padding: 1.2rem 0.5rem; width: 100%; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; cursor: pointer; position: relative; }
        .episode-btn:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(255,107,107,0.4); border-color: #ff6b6b; background: linear-gradient(145deg, #2a2a2a, #1e1e1e); }
        .episode-btn.playing { background: linear-gradient(145deg, #ff6b6b, #ff4757); border-color: #ff4757; }
        .episode-btn.loading { opacity: 0.7; cursor: wait; }
        .episode-number { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.3rem; }
        .episode-duration { font-size: 0.85rem; opacity: 0.8; }
        .loading-spinner { width: 4rem; height: 4rem; }
        .error-box { background: rgba(220,53,69,0.1); border: 1px solid #dc3545; border-radius: 12px; padding: 2rem; text-align: center; }
        .badge-netshort { background: linear-gradient(135deg, #ff6b6b, #ff4757); color: white; padding: 0.5rem 1rem; font-weight: 600; }
        .badge-episode { font-size: 1.1rem; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
        .drama-tags .badge { background: #444; margin: 0 0.3rem 0.3rem 0; }
        /* Video player styles (sama seperti sebelumnya) */
        .video-player-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 10000; flex-direction: column; }
        .player-header { padding: 0.8rem 1rem; background: rgba(0, 0, 0, 0.95); border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; min-height: 60px; flex-shrink: 0; }
        .player-title { font-size: 1rem; font-weight: bold; color: #ff6b6b; max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.3; }
        .player-close-btn { background: rgba(255, 107, 107, 0.2); border: 1px solid #ff6b6b; color: white; font-size: 1.2rem; cursor: pointer; padding: 0.4rem 0.8rem; border-radius: 8px; transition: background 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .player-close-btn:hover { background: #ff6b6b; }
        .video-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; padding: 0.5rem; min-height: 0; }
        #video-player { width: 100%; max-width: 1200px; max-height: 100%; border-radius: 8px; background: #000; object-fit: contain; }
        .player-controls { padding: 0.8rem; background: rgba(0, 0, 0, 0.95); border-top: 1px solid #444; display: flex; flex-wrap: wrap; gap: 0.8rem; align-items: center; justify-content: center; flex-shrink: 0; }
        .control-btn { background: rgba(255, 107, 107, 0.2); border: 1px solid #ff6b6b; color: white; padding: 0.6rem 0.8rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; min-height: 44px; }
        .control-btn:hover { background: #ff6b6b; }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; background: rgba(255, 107, 107, 0.1); }
        .episode-nav { display: flex; gap: 0.5rem; flex: 1; justify-content: center; }
        .fullscreen-btn { min-width: 120px; }
        @media (max-width: 768px) { /* mobile styles sama */ }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-black sticky-top shadow-lg">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <i class="bi bi-play-circle me-2"></i>
                <span>DramaShort</span>
            </a>
            <div class="navbar-nav ms-auto">
                <a href="/" class="btn btn-outline-light back-btn">
                    <i class="bi bi-arrow-left me-2"></i>Kembali ke Home
                </a>
            </div>
        </div>
    </nav>
    <main class="container py-5">
        <section id="drama-detail" class="mb-5">
            <div class="text-center py-5">
                <div class="spinner-border loading-spinner text-danger" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mt-3">Memuat detail short drama...</h4>
            </div>
        </section>
        <section class="mt-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">
                    <i class="bi bi-play-btn me-2 text-danger"></i>Daftar Episode
                </h3>
                <div id="episode-count" class="badge badge-netshort badge-episode">
                    <span id="count-text">0 Episode</span>
                </div>
            </div>
            <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3" id="episode-list"></div>
            <div id="no-episodes" class="text-center py-5" style="display: none;">
                <div class="alert alert-info w-75 mx-auto">
                    <i class="bi bi-info-circle display-4 d-block mb-3"></i>
                    <h4>Episode Belum Tersedia</h4>
                </div>
            </div>
        </section>
    </main>
  
    <!-- Video Player (sama) -->
    <div id="video-player-container" class="video-player-container">
        <div class="player-header">
            <div id="player-title" class="player-title">Episode 1</div>
            <button class="player-close-btn" onclick="closeVideoPlayer()">Ã—</button>
        </div>
        <div class="video-wrapper">
            <video id="video-player" controls playsinline>
                Your browser does not support the video tag.
            </video>
        </div>
        <div class="player-controls">
            <div class="episode-nav">
                <button class="control-btn" onclick="playPrevEpisode()" id="prev-btn">
                    <i class="bi bi-skip-backward"></i> <span class="btn-text">Prev</span>
                </button>
                <button class="control-btn" onclick="playNextEpisode()" id="next-btn">
                    <span class="btn-text">Next</span> <i class="bi bi-skip-forward"></i>
                </button>
            </div>
            <button class="control-btn fullscreen-btn" onclick="toggleFullscreen()">
                <i class="bi bi-fullscreen"></i> <span class="btn-text">Fullscreen</span>
            </button>
        </div>
    </div>

    <script>
        // ============== CONFIG & STATE ==============
        const CONFIG = {
            defaultImage: 'https://www.svgrepo.com/show/475529/cinema.svg'
        };
        let currentDramaInfo = null;
        let episodeList = [];
        let isLoading = false;
        let currentEpisodeIndex = 1;
        let totalEpisodes = 0;
        let videoPlayer = null;
        let dramaCover = CONFIG.defaultImage;
        const elements = {
            dramaDetail: document.getElementById('drama-detail'),
            episodeList: document.getElementById('episode-list'),
            episodeCount: document.getElementById('episode-count'),
            countText: document.getElementById('count-text'),
            noEpisodes: document.getElementById('no-episodes'),
            videoPlayerContainer: document.getElementById('video-player-container'),
            videoPlayer: document.getElementById('video-player'),
            playerTitle: document.getElementById('player-title'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn')
        };

        // ============== INIT ==============
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const dramaId = urlParams.get('id');
            if (!dramaId) return window.location.href = '/';
            loadDramaDetail(dramaId);
          
            videoPlayer = elements.videoPlayer;
            setupVideoPlayer();
        });

        // ============== MAIN LOAD (diperbaiki untuk struktur real API) ==============
        async function loadDramaDetail(dramaId) {
            if (isLoading) return;
            isLoading = true;
            try {
                const res = await fetch(`https://dramabos.asia/api/netshort/api/drama/info/${dramaId}?lang=id_ID`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                if (!json.success || !json.data) throw new Error('Drama tidak ditemukan atau response invalid');
                
                const data = json.data;
                currentDramaInfo = data.dramaInfo || {};  // metadata lengkap di sini
                episodeList = Array.isArray(data.result) ? data.result : [];  // episodes di 'result'
                totalEpisodes = episodeList.length || currentDramaInfo.totalEpisode || 0;
                dramaCover = currentDramaInfo.shortPlayCover || data.name ? CONFIG.defaultImage : CONFIG.defaultImage;  // fallback
                
                // Fallback judul kalau shortPlayName tidak ada
                if (!currentDramaInfo.shortPlayName && data.name) {
                    currentDramaInfo.shortPlayName = data.name;
                }
                
                renderDramaDetail(currentDramaInfo);
                renderEpisodes(episodeList);
            } catch (err) {
                console.error('Load error:', err);
                showError(`Gagal memuat detail: ${err.message}. Cek console untuk detail.`);
            } finally {
                isLoading = false;
            }
        }

        function renderDramaDetail(info) {
            document.title = `${escapeHtml(info.shortPlayName || 'Short Drama')} - DramaShort`;
            const tagsHtml = (info.shortPlayLabels || []).map(tag => 
                `<span class="badge bg-secondary me-1 mb-1">${escapeHtml(tag)}</span>`
            ).join('');
            
            const html = `
                <div class="row">
                    <div class="col-lg-4 col-md-5 mb-4 mb-md-0">
                        <div class="position-sticky" style="top: 90px;">
                            <img src="${dramaCover}"
                                 class="drama-poster mb-4"
                                 alt="${escapeHtml(info.shortPlayName || 'Drama')}"
                                 onerror="this.src='${CONFIG.defaultImage}';">
                            <div class="d-grid gap-2">
                                <button class="btn btn-danger btn-lg py-3" onclick="playEpisode(1)">
                                    <i class="bi bi-play-fill me-2"></i>Putar Episode 1
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8 col-md-7">
                        <h1 class="drama-title">${escapeHtml(info.shortPlayName || 'Unknown')}</h1>
                        <div class="d-flex flex-wrap gap-3 mb-4">
                            <span class="badge badge-netshort">
                                <i class="bi bi-film me-1"></i>${totalEpisodes} Episode
                            </span>
                            ${info.isFinish === 1 ? '<span class="badge bg-success">Tamat</span>' : '<span class="badge bg-warning">Sedang Tayang</span>'}
                        </div>
                        <div class="synopsis-box mb-4">
                            <h5 class="fw-bold mb-3"><i class="bi bi-info-circle text-danger me-2"></i>Sinopsis</h5>
                            <p>${escapeHtml(info.shotIntroduce || 'Tidak ada sinopsis tersedia.')}</p>
                            ${tagsHtml ? `<div class="drama-tags mt-3"><h6>Tags:</h6>${tagsHtml}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            elements.dramaDetail.innerHTML = html;
        }

        function renderEpisodes(episodes) {
            if (!episodes || episodes.length === 0) {
                showNoEpisodes();
                return;
            }
            elements.countText.textContent = `${episodes.length} Episode`;
            elements.episodeList.style.display = 'flex';
            elements.noEpisodes.style.display = 'none';
            
            const html = episodes.map((ep, index) => {
                const episodeNum = ep.episodeNo || (index + 1);
                const duration = '';  // API tidak kasih duration, bisa tambah kalau nanti ada
                return `
                    <div class="col">
                        <div class="episode-card">
                            <button class="episode-btn w-100"
                                    onclick="playEpisode(${episodeNum})"
                                    data-index="${episodeNum}"
                                    title="Episode ${episodeNum}">
                                <div class="episode-number">Episode ${episodeNum}</div>
                                <div class="episode-duration">${duration}</div>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            elements.episodeList.innerHTML = html;
        }

        // ============== PLAY FUNCTIONS (sama, tapi pakai videoUrl langsung) ==============
        function playEpisode(episodeNumber) {
            const ep = episodeList.find(e => e.episodeNo === episodeNumber);
            if (!ep || !ep.videoUrl) {
                alert('Episode tidak tersedia atau URL video tidak ditemukan');
                return;
            }
            currentEpisodeIndex = episodeNumber;
            playVideoInline(ep.videoUrl, episodeNumber);
            markEpisodeAsPlaying(episodeNumber);
            saveLastWatched(episodeNumber);
        }

        function playNextEpisode() {
            if (currentEpisodeIndex < totalEpisodes) {
                playEpisode(currentEpisodeIndex + 1);
            }
        }

        function playPrevEpisode() {
            if (currentEpisodeIndex > 1) {
                playEpisode(currentEpisodeIndex - 1);
            }
        }

        function playVideoInline(videoUrl, episodeIndex) {
            try {
                elements.videoPlayer.src = videoUrl;
                elements.playerTitle.textContent = `Episode ${episodeIndex}`;
                updateNavigationButtons();
                elements.videoPlayerContainer.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                videoPlayer.load();
                videoPlayer.play().catch(err => console.error('Play error:', err));
                markEpisodeAsPlaying(episodeIndex);
            } catch (error) {
                alert('Gagal memutar video: ' + error.message);
            }
        }

        function closeVideoPlayer() {
            elements.videoPlayerContainer.style.display = 'none';
            videoPlayer.pause();
            videoPlayer.src = '';
            document.body.style.overflow = '';
        }

        function setupVideoPlayer() {
            videoPlayer.addEventListener('ended', handleVideoEnded);
            videoPlayer.addEventListener('fullscreenchange', handleFullscreenChange);
            videoPlayer.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        }

        function handleVideoEnded() {
            if (currentEpisodeIndex < totalEpisodes) {
                setTimeout(playNextEpisode, 1500);
            }
        }

        function toggleFullscreen() {
            const container = elements.videoPlayerContainer;
            if (!document.fullscreenElement) {
                container.requestFullscreen?.() || container.webkitRequestFullscreen?.();
            } else {
                document.exitFullscreen?.() || document.webkitExitFullscreen?.();
            }
        }

        function handleFullscreenChange() {
            const isFullscreen = !!document.fullscreenElement;
            const icon = document.querySelector('.fullscreen-btn i');
            if (icon) icon.className = isFullscreen ? 'bi bi-fullscreen-exit' : 'bi bi-fullscreen';
        }

        function updateNavigationButtons() {
            elements.prevBtn.disabled = currentEpisodeIndex <= 1;
            elements.prevBtn.style.opacity = currentEpisodeIndex <= 1 ? '0.5' : '1';
            elements.nextBtn.disabled = currentEpisodeIndex >= totalEpisodes;
            elements.nextBtn.style.opacity = currentEpisodeIndex >= totalEpisodes ? '0.5' : '1';
        }

        function markEpisodeAsPlaying(index) {
            document.querySelectorAll('.episode-btn').forEach(btn => {
                btn.classList.remove('playing');
                if (parseInt(btn.dataset.index) === index) btn.classList.add('playing');
            });
        }

        function saveLastWatched(index) {
            if (currentDramaInfo?.shortPlayId) {
                localStorage.setItem(`last_netshort_${currentDramaInfo.shortPlayId}`, index);
            }
        }

        function showNoEpisodes() {
            elements.episodeList.style.display = 'none';
            elements.noEpisodes.style.display = 'block';
            elements.countText.textContent = '0 Episode';
        }

        function showError(msg) {
            elements.dramaDetail.innerHTML = `
                <div class="error-box">
                    <i class="bi bi-exclamation-triangle-fill display-1 text-danger mb-3"></i>
                    <h4>Terjadi Kesalahan</h4>
                    <p>${escapeHtml(msg)}</p>
                    <button onclick="location.reload()" class="btn btn-danger mt-3">Coba Lagi</button>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Global functions
        window.playEpisode = playEpisode;
        window.closeVideoPlayer = closeVideoPlayer;
        window.playPrevEpisode = playPrevEpisode;
        window.playNextEpisode = playNextEpisode;
        window.toggleFullscreen = toggleFullscreen;

        elements.videoPlayerContainer.addEventListener('click', e => {
            if (e.target === elements.videoPlayerContainer) closeVideoPlayer();
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && elements.videoPlayerContainer.style.display === 'flex') {
                closeVideoPlayer();
            }
            if (elements.videoPlayerContainer.style.display !== 'flex') return;
            if (e.key === ' ') { e.preventDefault(); videoPlayer[videoPlayer.paused ? 'play' : 'pause'](); }
            if (e.key === 'ArrowLeft') { e.preventDefault(); videoPlayer.currentTime -= 10; }
            if (e.key === 'ArrowRight') { e.preventDefault(); videoPlayer.currentTime += 10; }
            if (e.key === 'f' || e.key === 'F') { e.preventDefault(); toggleFullscreen(); }
            if (e.key === 'n' || e.key === 'N') { e.preventDefault(); playNextEpisode(); }
            if (e.key === 'p' || e.key === 'P') { e.preventDefault(); playPrevEpisode(); }
        });
    </script>
</body>
</html>
