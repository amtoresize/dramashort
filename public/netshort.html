<!DOCTYPE html>
<html lang="id" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetShort - Nonton Video Pendek</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* ========== VARIABLES ========== */
        :root {
            --primary: #2ed573;
            --primary-dark: #1dd1a1;
            --secondary: #54a0ff;
            --dark-bg: #0a0a0a;
            --card-bg: #1a1a1a;
            --text-light: #f8f9fa;
            --text-muted: #adb5bd;
        }
        
        /* ========== BASE STYLES ========== */
        body {
            background: var(--dark-bg);
            color: var(--text-light);
            font-family: 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            background-image: radial-gradient(circle at 80% 20%, rgba(46, 213, 115, 0.1) 0%, transparent 25%);
        }
        
        /* ========== NAVBAR ========== */
        .navbar {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(46, 213, 115, 0.1);
        }
        
        .navbar-brand {
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        /* ========== VIDEO DETAIL ========== */
        .video-container {
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            margin-bottom: 2rem;
            position: relative;
        }
        
        .video-player {
            width: 100%;
            height: auto;
            aspect-ratio: 9/16; /* Vertical/short video format */
            background: #000;
            display: block;
        }
        
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 2rem 1.5rem 1rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .video-container:hover .video-controls {
            opacity: 1;
        }
        
        .video-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
            line-height: 1.3;
        }
        
        /* ========== VIDEO INFO ========== */
        .video-info {
            background: rgba(40, 40, 40, 0.7);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .badge-netshort {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .tag-badge {
            background: rgba(46, 213, 115, 0.2);
            color: var(--primary);
            border: 1px solid rgba(46, 213, 115, 0.3);
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        /* ========== RELATED VIDEOS ========== */
        .related-video-card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid #333;
        }
        
        .related-video-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(46, 213, 115, 0.2);
        }
        
        .related-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        
        .related-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-light);
            margin: 0.8rem 1rem 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
        }
        
        .related-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 0 1rem 0.8rem;
        }
        
        /* ========== LOADING ========== */
        .loading-spinner {
            width: 3rem;
            height: 3rem;
            color: var(--primary);
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .video-title {
                font-size: 1.5rem;
            }
            
            .video-player {
                aspect-ratio: 16/9; /* Horizontal on mobile */
            }
            
            .video-container {
                border-radius: 12px;
            }
        }
        
        @media (max-width: 576px) {
            .video-title {
                font-size: 1.3rem;
            }
            
            .video-info {
                padding: 1rem;
            }
            
            .related-thumbnail {
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-lightning-charge-fill me-2"></i>NetShort
            </a>
            <div class="navbar-nav ms-auto">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Kembali ke Home
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container py-4">
        <!-- Video Player Section -->
        <section id="video-section" class="mb-5">
            <div class="text-center py-5" id="loading-section">
                <div class="spinner-border loading-spinner" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mt-3">Memuat video...</h4>
            </div>
            
            <div id="video-content" style="display: none;">
                <div class="video-container">
                    <video id="video-player" class="video-player" controls playsinline>
                        Your browser does not support the video tag.
                    </video>
                    <div class="video-controls">
                        <!-- Controls can be added here -->
                    </div>
                </div>
                
                <div class="video-info">
                    <h2 id="video-title" class="video-title mb-3"></h2>
                    
                    <div class="d-flex flex-wrap gap-2 align-items-center mb-4">
                        <span class="badge-netshort">
                            <i class="bi bi-lightning-charge me-1"></i> NetShort Video
                        </span>
                        <span id="heat-score" class="badge bg-secondary ms-2">
                            <i class="bi bi-fire me-1"></i> 0 Views
                        </span>
                    </div>
                    
                    <!-- Tags -->
                    <div id="tags-container" class="d-flex flex-wrap gap-2 mb-3"></div>
                    
                    <!-- Description -->
                    <div id="video-description" class="mb-4"></div>
                </div>
            </div>
        </section>

        <!-- Related Videos -->
        <section class="mt-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">
                    <i class="bi bi-collection-play me-2"></i>Video Terkait
                </h3>
                <button id="load-related" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
            
            <div id="related-videos" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3">
                <!-- Related videos will be loaded here -->
            </div>
            
            <!-- No Related Videos -->
            <div id="no-related" class="text-center py-5" style="display: none;">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle display-4 d-block mb-3"></i>
                    <h4>Tidak ada video terkait</h4>
                    <p>Coba refresh atau cari video lainnya.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Script -->
    <script>
        // ============== CONFIGURATION ==============
        const CONFIG = {
            defaultImage: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjUwMCIgZmlsbD0iIzIyMiIvPjx0ZXh0IHg9IjE1MCIgeT0iMjUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5ldFNob3J0IFZpZGVvPC90ZXh0Pjwvc3ZnPg=='
        };

        // ============== STATE VARIABLES ==============
        let currentVideo = null;
        let relatedVideos = [];
        const videoPlayer = document.getElementById('video-player');

        // ============== INITIALIZATION ==============
        document.addEventListener('DOMContentLoaded', function() {
            console.log('NetShort Video initialized');
            
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('id');
            
            if (!videoId) {
                window.location.href = '/';
                return;
            }
            
            // Load video detail
            loadVideoDetail(videoId);
            
            // Load related videos
            loadRelatedVideos();
            
            // Setup load related button
            document.getElementById('load-related').addEventListener('click', loadRelatedVideos);
            
            // Handle video events
            videoPlayer.addEventListener('ended', onVideoEnded);
        });

        // ============== MAIN FUNCTIONS ==============

        /**
         * Load video detail from NetShort API
         */
        async function loadVideoDetail(videoId) {
            try {
                // First try to get from explore/discover data
                const cachedVideo = await findCachedVideo(videoId);
                if (cachedVideo) {
                    renderVideoDetail(cachedVideo);
                    return;
                }
                
                // If not cached, try to fetch from API
                const response = await fetch(`https://dramabos.asia/api/netshort/api/drama/info/${videoId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    currentVideo = data.data;
                    renderVideoDetail(data.data);
                    
                    // Try to play video if URL available
                    if (data.data.result && data.data.result[0] && data.data.result[0].videoUrl) {
                        playVideo(data.data.result[0].videoUrl);
                    }
                } else {
                    throw new Error('Video tidak ditemukan');
                }
            } catch (error) {
                console.error('Error loading video detail:', error);
                showError(`Gagal memuat video: ${error.message}`);
            } finally {
                // Hide loading
                document.getElementById('loading-section').style.display = 'none';
                document.getElementById('video-content').style.display = 'block';
            }
        }

        /**
         * Find video in cache (from explore/discover)
         */
        async function findCachedVideo(videoId) {
            try {
                // Try explore endpoint first
                const exploreResponse = await fetch('https://dramabos.asia/api/netshort/api/drama/explore?offset=0&limit=50');
                const exploreData = await exploreResponse.json();
                
                if (exploreData.success && exploreData.data && exploreData.data.result) {
                    const video = exploreData.data.result.find(v => v.id === videoId);
                    if (video) return { ...video, source: 'explore' };
                }
                
                // Try discover endpoint
                const discoverResponse = await fetch('https://dramabos.asia/api/netshort/api/drama/discover');
                const discoverData = await discoverResponse.json();
                
                if (discoverData.success && discoverData.data && discoverData.data.dataList) {
                    const video = discoverData.data.dataList.find(v => v.shortPlayId === videoId);
                    if (video) return { ...video, source: 'discover' };
                }
            } catch (error) {
                console.log('Cache search error:', error);
            }
            
            return null;
        }

        /**
         * Render video detail
         */
        function renderVideoDetail(video) {
            currentVideo = video;
            
            // Set page title
            const title = video.shortPlayName || video.name || 'NetShort Video';
            document.title = `${escapeHtml(title)} - NetShort`;
            
            // Update video title
            document.getElementById('video-title').textContent = title;
            
            // Update heat score
            if (video.heatScoreShow) {
                document.getElementById('heat-score').innerHTML = `
                    <i class="bi bi-fire me-1"></i> ${video.heatScoreShow}
                `;
            }
            
            // Render tags
            const tagsContainer = document.getElementById('tags-container');
            if (video.labelArray && video.labelArray.length > 0) {
                tagsContainer.innerHTML = video.labelArray.map(tag => `
                    <span class="tag-badge">${escapeHtml(tag)}</span>
                `).join('');
            } else if (video.scriptName) {
                tagsContainer.innerHTML = `
                    <span class="tag-badge">${escapeHtml(video.scriptName)}</span>
                `;
            }
            
            // Render description
            const descriptionEl = document.getElementById('video-description');
            if (video.script) {
                descriptionEl.innerHTML = `
                    <h6 class="fw-bold mb-2"><i class="bi bi-info-circle me-2"></i>Deskripsi</h6>
                    <p class="mb-0">${escapeHtml(video.script)}</p>
                `;
            } else {
                descriptionEl.innerHTML = `
                    <p class="text-muted mb-0"><i>Belum ada deskripsi</i></p>
                `;
            }
        }

        /**
         * Play video
         */
        function playVideo(videoUrl) {
            if (!videoUrl) {
                console.log('No video URL available');
                return;
            }
            
            videoPlayer.src = videoUrl;
            videoPlayer.load();
            
            // Try to play automatically
            const playPromise = videoPlayer.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log('Auto-play prevented:', error);
                    // Show custom play button if needed
                });
            }
            
            // Save to history
            saveToHistory();
        }

        /**
         * Load related videos
         */
        async function loadRelatedVideos() {
            try {
                // Show loading state
                document.getElementById('related-videos').innerHTML = `
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                        <p class="mt-2 text-muted">Memuat video terkait...</p>
                    </div>
                `;
                
                // Fetch related videos from explore endpoint
                const response = await fetch('https://dramabos.asia/api/netshort/api/drama/explore?offset=0&limit=20');
                const data = await response.json();
                
                if (data.success && data.data && data.data.result) {
                    relatedVideos = data.data.result;
                    renderRelatedVideos(relatedVideos);
                } else {
                    showNoRelatedVideos();
                }
            } catch (error) {
                console.error('Error loading related videos:', error);
                showNoRelatedVideos();
            }
        }

        /**
         * Render related videos
         */
        function renderRelatedVideos(videos) {
            if (!videos || videos.length === 0) {
                showNoRelatedVideos();
                return;
            }
            
            // Filter out current video
            const filteredVideos = videos.filter(video => 
                video.id !== currentVideo?.id && 
                video.shortPlayId !== currentVideo?.shortPlayId
            ).slice(0, 10); // Limit to 10 videos
            
            if (filteredVideos.length === 0) {
                showNoRelatedVideos();
                return;
            }
            
            const relatedHtml = filteredVideos.map(video => {
                const title = video.shortPlayName || video.name || 'NetShort Video';
                const cover = video.shortPlayCover || video.cover || CONFIG.defaultImage;
                const videoId = video.shortPlayId || video.id;
                
                return `
                    <div class="col">
                        <div class="related-video-card" onclick="playRelatedVideo('${videoId}')">
                            <img src="${cover}" 
                                 class="related-thumbnail"
                                 alt="${escapeHtml(title)}"
                                 loading="lazy"
                                 onerror="this.src='${CONFIG.defaultImage}'">
                            <div class="related-title">${escapeHtml(title)}</div>
                            <div class="related-meta">
                                <small><i class="bi bi-play-circle"></i> NetShort</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('related-videos').innerHTML = relatedHtml;
            document.getElementById('no-related').style.display = 'none';
        }

        /**
         * Play related video
         */
        function playRelatedVideo(videoId) {
            // Update URL without reloading page
            const newUrl = `${window.location.pathname}?id=${videoId}`;
            window.history.pushState({}, '', newUrl);
            
            // Show loading
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('video-content').style.display = 'none';
            
            // Load new video
            loadVideoDetail(videoId);
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        /**
         * Handle video ended event
         */
        function onVideoEnded() {
            console.log('Video ended');
            
            // Auto-play next video if available
            if (relatedVideos.length > 0) {
                // Find current video index
                const currentIndex = relatedVideos.findIndex(video => 
                    video.id === currentVideo?.id || 
                    video.shortPlayId === currentVideo?.shortPlayId
                );
                
                // Play next video
                const nextIndex = (currentIndex + 1) % relatedVideos.length;
                const nextVideo = relatedVideos[nextIndex];
                
                if (nextVideo) {
                    setTimeout(() => {
                        playRelatedVideo(nextVideo.shortPlayId || nextVideo.id);
                    }, 2000); // Wait 2 seconds before auto-playing next
                }
            }
        }

        // ============== UI HELPER FUNCTIONS ==============

        /**
         * Show no related videos
         */
        function showNoRelatedVideos() {
            document.getElementById('related-videos').innerHTML = '';
            document.getElementById('no-related').style.display = 'block';
        }

        /**
         * Show error message
         */
        function showError(message) {
            document.getElementById('video-content').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Error:</strong> ${escapeHtml(message)}
                    <div class="mt-2">
                        <button onclick="window.location.href='/'" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-house"></i> Kembali ke Home
                        </button>
                        <button onclick="location.reload()" class="btn btn-sm btn-primary ms-2">
                            <i class="bi bi-arrow-clockwise"></i> Coba Lagi
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Save video to watch history
         */
        function saveToHistory() {
            if (currentVideo) {
                const history = {
                    videoId: currentVideo.shortPlayId || currentVideo.id,
                    title: currentVideo.shortPlayName || currentVideo.name,
                    cover: currentVideo.shortPlayCover || currentVideo.cover,
                    source: 'netshort',
                    timestamp: Date.now()
                };
                
                // Get existing history
                const existingHistory = JSON.parse(localStorage.getItem('netshort_history') || '[]');
                
                // Remove if already exists
                const filteredHistory = existingHistory.filter(item => 
                    item.videoId !== history.videoId
                );
                
                // Add to beginning and limit to 50 items
                filteredHistory.unshift(history);
                const limitedHistory = filteredHistory.slice(0, 50);
                
                localStorage.setItem('netshort_history', JSON.stringify(limitedHistory));
            }
        }

        // ============== UTILITY FUNCTIONS ==============

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============== GLOBAL EXPORTS ==============
        window.playRelatedVideo = playRelatedVideo;
    </script>
</body>
</html>
